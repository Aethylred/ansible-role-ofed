---
# tasks file for ofed

- name: Install the repository
  command: yum-config-manager --add-repo {{ ofed_repo_file }}
  args:
    creates: /etc/yum.repos.d/{{ ofed_repo_name }}
  become: true
  when:
    - ansible_os_family == "RedHat"
    - ansible_distribution_major_version < '8'

- name: Install the repository
  command: dnf config-manager --add-repo {{ ofed_repo_file }}
  args:
    creates: /etc/yum.repos.d/{{ ofed_repo_name }}
  become: true
  when:
    - ansible_os_family == "RedHat"
    - ansible_distribution_major_version >= '8'

- name: Install the GPG key
  rpm_key:
    key: http://www.mellanox.com/downloads/ofed/RPM-GPG-KEY-Mellanox
  become: true

- name: Install infiniband support
  yum:
    name: "@Infiniband Support"
    state: present
  when:
    - ansible_os_family == "RedHat"
    - ansible_distribution_major_version < '8'

- name: Install infiniband support
  dnf:
    name: "@Infiniband Support"
    state: present
  when:
    - ansible_os_family == "RedHat"
    - ansible_distribution_major_version >= '8'

- name: Determine which kernel version is supported
  # Produces: 3.10.0-1127.el7.x86_64
  shell: |-
    set -o pipefail
    rpm -ql kmod-mlnx-ofa_kernel | grep "/lib/modules" | awk -F "/" '{print $4}' | uniq
  args:
    executable: /bin/bash
  register: supported_kernel
  changed_when: false

- name: Install supported kernel
  package:
    name: "kernel-{{ supported_kernel.stdout }}"
  become: true
